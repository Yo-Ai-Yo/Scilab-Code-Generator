<script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
        const [query, setQuery] = useState("");
        const [generatedCode, setGeneratedCode] = useState("");
        const [error, setError] = useState("");
        const [darkMode, setDarkMode] = useState(false);
        const [codeHistory, setCodeHistory] = useState([]);
        const [showHistory, setShowHistory] = useState(false);
        const [sidebarOpen, setSidebarOpen] = useState(false);

        // Load code history from localStorage on mount
        useEffect(() => {
            const savedHistory = localStorage.getItem("codeHistory");
            if (savedHistory) {
                setCodeHistory(JSON.parse(savedHistory));
            }
        }, []);

        // Save code history to localStorage whenever it changes
        useEffect(() => {
            localStorage.setItem("codeHistory", JSON.stringify(codeHistory));
        }, [codeHistory]);

        // Call Awan API with error handling
        const callAwanApi = async (prompt, maxTokens = 500) => {
            try {
                const response = await fetch("https://api.awanllm.com/v1/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer 3b38e8c8-5a6b-4e7e-a373-f85048d14675", // REPLACE WITH YOUR AWAN API KEY
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "Awanllm-Llama-3-8B-Cumulus",
                        prompt: prompt,
                        max_tokens: maxTokens,
                        temperature: 0.7
                    })
                });
                if (response.status === 429) {
                    throw new Error("Rate limit exceeded. Please wait a minute and try again.");
                }
                if (!response.ok) {
                    throw new Error(API error: ${response.statusText});
                }
                const data = await response.json();
                return data.choices[0].text.trim();
            } catch (err) {
                setError(err.message);
                return null;
            }
        };

        // Handle query submission to generate Scilab code
        const handleSubmit = async () => {
            if (!query) {
                setError("Please enter a query before submitting.");
                return;
            }

            setError("");
            setGeneratedCode(""); // Clear previous code while generating

            const prompt = Generate Scilab code for the following request: "${query}". Provide only the code without additional explanations.;
            const code = await callAwanApi(prompt);

            if (code) {
                const newEntry = {
                    timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
                    query: query,
                    code: code
                };
                setCodeHistory([...codeHistory, newEntry]);
                setGeneratedCode(code);
                setQuery(""); // Clear the input
            }
            setSidebarOpen(false); // Close sidebar on mobile after submitting
        };

        // Export code history
        const exportHistory = () => {
            const exportText = codeHistory.map(entry => 
                ${entry.timestamp}\nQuery: ${entry.query}\n\n${entry.code}\n---\n
            ).join("");
            const blob = new Blob([exportText], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "scilab_code_history.txt";
            a.click();
            URL.revokeObjectURL(url);
            setSidebarOpen(false); // Close sidebar on mobile after exporting
        };

        // Clear history
        const clearHistory = () => {
            setCodeHistory([]);
            localStorage.removeItem("codeHistory");
            setShowHistory(false);
            setSidebarOpen(false); // Close sidebar on mobile after clearing
        };

        return (
            <div className={min-h-screen ${darkMode ? "dark" : ""} bg-neutral}>
                {/* Hamburger Menu for Mobile */}
                <div className="md:hidden fixed top-4 left-4 z-50">
                    <button onClick={() => setSidebarOpen(true)} className="text-gray-800 dark:text-gray-200 hamburger-menu">
                        <svg className="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>

                {/* Sidebar */}
                <div className={fixed inset-y-0 left-0 w-64 bg-blue-800 dark:bg-gray-900 text-white p-4 h-screen transform ${sidebarOpen ? "translate-x-0" : "-translate-x-full"} md:translate-x-0 transition-transform duration-300 ease-in-out z-40}>
                    <div className="flex justify-between items-center mb-6 md:mb-6">
                        <h1 className="text-xl font-semibold">Scilab Code Assistant</h1>
                        <button onClick={() => setSidebarOpen(false)} className="md:hidden text-gray-200">
                            <svg className="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <nav className="space-y-2">
                        <button
                            onClick={() => { setShowHistory(false); setSidebarOpen(false); }}
                            className="w-full flex items-center p-2 rounded-lg hover:bg-blue-700 dark:hover:bg-gray-800 transition"
                        >
                            <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            Generate Code
                        </button>
                        <button
                            onClick={() => { setShowHistory(true); setSidebarOpen(false); }}
                            className="w-full flex items-center p-2 rounded-lg hover:bg-blue-700 dark:hover:bg-gray-800 transition"
                        >
                            <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Past Codes
                        </button>
                        <button
                            onClick={() => { setDarkMode(!darkMode); setSidebarOpen(false); }}
                            className="w-full flex items-center p-2 rounded-lg hover:bg-blue-700 dark:hover:bg-gray-800 transition"
                        >
                            <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            {darkMode ? "Light Mode" : "Dark Mode"}
                        </button>
                    </nav>
                </div>

                {/* Overlay for Mobile Sidebar */}
                {sidebarOpen && (
                    <div 
                        className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-30"
                        onClick={() => setSidebarOpen(false)}
                    ></div>
                )}

                {/* Main Content */}
                <main className="md:ml-64 p-4 md:p-8 flex-1 pt-16 md:pt-0">
                    {/* Error Message */}
                    {error && (
                        <div className="mb-6 p-4 bg-red-100 text-red-700 rounded-lg fade-in-scale">
                            {error}
                        </div>
                    )}

                    {/* Query Input */}
                    <div className="mb-6 glass p-4 md:p-6 fade-in-scale">
                        <label className="block text-base md:text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">
                            What Scilab code would you like to generate?
                        </label>
                        <textarea
                            value={query}
                            onChange={(e) => setQuery(e.target.value)}
                            placeholder="e.g., Write a Scilab code to solve a quadratic equation"
                            className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 text-sm md:text-base"
                            rows="3"
                        />
                        <button
                            onClick={handleSubmit}
                            className="mt-3 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition transform hover:scale-105 w-full md:w-auto text-sm md:text-base"
                        >
                            Generate Code
                        </button>
                    </div>

                    {/* Generated Code */}
                    {generatedCode && (
                        <div className="mb-6 glass p-4 md:p-6 fade-in-scale">
                            <h2 className="text-lg md:text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Generated Scilab Code</h2>
                            <pre><code>{generatedCode}</code></pre>
                        </div>
                    )}
                </main>

                {/* History Modal */}
                {showHistory && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-lg w-full max-w-lg max-h-[80vh] overflow-y-auto fade-in-scale m-4">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg md:text-xl font-semibold text-gray-800 dark:text-gray-200">Past Codes</h2>
                                <button onClick={() => setShowHistory(false)} className="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                                    <svg className="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {codeHistory.length === 0 ? (
                                <p className="text-gray-700 dark:text-gray-300 text-sm md:text-base">No generated codes yet.</p>
                            ) : (
                                <div className="space-y-4">
                                    {codeHistory.map((entry, index) => (
                                        <div key={index} className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                            <p className="text-gray-800 dark:text-gray-200 text-sm md:text-base"><strong>{entry.timestamp}</strong></p>
                                            <p className="text-gray-700 dark:text-gray-300 text-sm md:text-base"><strong>Query:</strong> {entry.query}</p>
                                            <pre><code>{entry.code}</code></pre>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mt-4">
                                <button
                                    onClick={exportHistory}
                                    className="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition transform hover:scale-105 w-full md:w-auto text-sm md:text-base"
                                >
                                    Export History
                                </button>
                                <button
                                    onClick={clearHistory}
                                    className="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition transform hover:scale-105 w-full md:w-auto text-sm md:text-base"
                                >
                                    Clear History
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
</script>
